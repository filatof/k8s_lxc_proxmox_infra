# k8s_lxc_proxmox_infra

–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–æ–µ–∫—Ç –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è –∫–ª–∞—Å—Ç–µ—Ä–∞ Kubernetes –Ω–∞ –±–∞–∑–µ LXC-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –≤ Proxmox VE. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **Ansible** –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞, –∞ —Ç–∞–∫–∂–µ **Terraform** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è LXC-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏–∑ —à–∞–±–ª–æ–Ω–∞.

---

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```
k8s_lxc_proxmox_infra/
‚îú‚îÄ‚îÄ ansible.cfg                 # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Ansible
‚îú‚îÄ‚îÄ inventory/
‚îÇ   ‚îî‚îÄ‚îÄ inv_lxc.yml             # –ò–Ω–≤–µ–Ω—Ç–æ—Ä–∏-—Ñ–∞–π–ª Ansible –¥–ª—è Proxmox LXC
‚îú‚îÄ‚îÄ playbook/                   # Ansible playbooks
‚îÇ   ‚îú‚îÄ‚îÄ create_claster_k8s.yml     # –ü–ª–µ–π–±—É–∫ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ create_lxc_template.yml    # –ü–ª–µ–π–±—É–∫ —Å–æ–∑–¥–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–∞ LXC-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ remove_lxc.yml             # –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
‚îÇ   ‚îî‚îÄ‚îÄ tasks/
‚îÇ       ‚îî‚îÄ‚îÄ create_one_lxc.yml     # –ó–∞–¥–∞—á–∏ —Å–æ–∑–¥–∞–Ω–∏—è –æ–¥–Ω–æ–≥–æ LXC-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
‚îú‚îÄ‚îÄ terraform/                 # Terraform-–º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
‚îÇ   ‚îú‚îÄ‚îÄ k8s.tf                    # –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ Terraform
‚îÇ   ‚îú‚îÄ‚îÄ output.tf                # Outputs
‚îÇ   ‚îú‚îÄ‚îÄ provider.tf              # –ü—Ä–æ–≤–∞–π–¥–µ—Ä Proxmox
‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfvars         # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (–∑–Ω–∞—á–µ–Ω–∏—è)
‚îÇ   ‚îú‚îÄ‚îÄ variables.tf             # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
‚îÇ   ‚îú‚îÄ‚îÄ terraform.tfstate*       # –°–æ—Å—Ç–æ—è–Ω–∏–µ Terraform (–≤ .gitignore)
```

---

## ‚öôÔ∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Proxmox VE —Å –≤–∫–ª—é—á—ë–Ω–Ω—ã–º API
- Terraform >= 1.3
- Ansible >= 2.10
- –î–æ—Å—Ç—É–ø –ø–æ SSH –∫ Proxmox
- –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π LXC-—à–∞–±–ª–æ–Ω Ubuntu (Jammy), –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π systemd

---

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø—É—Å–∫—É

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —à–∞–±–ª–æ–Ω–∞ LXC –¥–ª—è Kubernetes

–°–æ–∑–¥–∞—ë—Ç LXC-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤ –Ω–µ–≥–æ:

- `containerd`, `runc`, `crictl`
- `kubeadm`, `kubelet`, `kubectl`
- –°–µ—Ç–µ–≤—ã–µ –ø–ª–∞–≥–∏–Ω—ã CNI

–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∫–∞–∫ —à–∞–±–ª–æ–Ω LXC –≤ Proxmox.

```bash
cd playbook
ansible-playbook -i ../inventory/inv_lxc.yml create_lxc_template.yml
```

---

### 2. –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏–µ LXC-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (—É–∑–ª–æ–≤ –∫–ª–∞—Å—Ç–µ—Ä–∞)

–° –ø–æ–º–æ—â—å—é Terraform —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—é—Ç—Å—è –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ LXC-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∏–∑ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞.

```bash
cd terraform
terraform init
terraform apply
```

> –ü—Ä–∏–º–µ—Ä terraform.tfvars:

```hcl
pm_user     = "root@pam"
pm_password = "your_password"
pm_host     = "proxmox.local"
template    = "local:vztmpl/ubuntu-jammy-modified_arm64.tar.xz"
target_node = "proxmox"
vm_count    = 3
```

---

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Kubernetes-–∫–ª–∞—Å—Ç–µ—Ä–∞

–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–ª–∞—Å—Ç–µ—Ä Kubernetes –Ω–∞ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã—Ö —É–∑–ª–∞—Ö:

- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è master-—É–∑–ª–∞ —á–µ—Ä–µ–∑ `kubeadm init`
- Join worker-—É–∑–ª–æ–≤ —á–µ—Ä–µ–∑ `kubeadm join`
- –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ç–µ–≤–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, Calico)
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è kubeconfig

```bash
cd playbook
ansible-playbook -i ../inventory/inv_lxc.yml create_claster_k8s.yml
```

---

### 4. –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ (–ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)

–£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ LXC-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã.

```bash
cd playbook
ansible-playbook -i ../inventory/inv_lxc.yml remove_lxc.yml
```

---

## üìå –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–∞ –±–∞–∑–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω–∞.
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è systemd –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞–º–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.
- –ú–æ–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å –ø–ª–µ–π–±—É–∫–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∫–ª–∞—Å—Ç–µ—Ä–∞ (Ingress, Helm, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ø—Ä.)

---

## üìù –ê–≤—Ç–æ—Ä

–°–æ–∑–¥–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º **fill** –≤ —Ä–∞–º–∫–∞—Ö —É—á–µ–±–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ Kubernetes –∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
